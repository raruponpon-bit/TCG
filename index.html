<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>デュエマ風カードゲーム(Firebase版)</title>
<style>
  body { font-family: Arial; padding: 20px; }
  #hand button { margin: 5px; }
  #battlefield div { margin: 5px; display:inline-block; padding:5px; border:1px solid black; }
</style>
</head>
<body>
<h1>デュエマ風カードゲーム(Firebase版)</h1>

<label>プレイヤーID: <input id="playerId" placeholder="AまたはB"></label>
<button id="joinBtn">参加</button>

<h2>ターン: <span id="turn">---</span></h2>

<h3>手札</h3>
<div id="hand"></div>

<h3>場</h3>
<div id="battlefield"></div>

<h3>ゲームログ</h3>
<div id="log"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

<script>
  // ===== Firebase 設定 =====
  const firebaseConfig = {
  apiKey: "AIzaSyAkZj5sB_L1ww4nmXwn-L1iJVxQbKtN2Os",
  authDomain: "tcg-project-c40c0.firebaseapp.com",
  projectId: "tcg-project-c40c0",
  storageBucket: "tcg-project-c40c0.firebasestorage.app",
  messagingSenderId: "460146966752",
  appId: "1:460146966752:web:22779f5306440b7bea1085",
  measurementId: "G-QQ90QBR4YK"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const gameId = "demoGame"; // 固定でもランダム生成可
  const gameRef = db.ref('games/' + gameId);

  let playerId = null;
  let gameData = null;

  // ===== DB監視（リアルタイム更新） =====
  gameRef.on('value', snapshot => {
    gameData = snapshot.val();
    if(!gameData) return;
    document.getElementById("turn").textContent = gameData.turn;
    render();
  });

  // ===== 参加ボタン =====
  document.getElementById("joinBtn").onclick = async () => {
    const pid = document.getElementById("playerId").value.trim().toUpperCase();
    if(pid !== "A" && pid !== "B") { alert("AかBを入力してください"); return; }
    playerId = pid;

    // 初期データがない場合は作成
    const snapshot = await gameRef.get();
    if(!snapshot.exists()){
      await gameRef.set({
        players: {
          A: {hand:["火の精霊","水の精霊","森の精霊"], battlefield:[]},
          B: {hand:["光の精霊","闇の精霊","風の精霊"], battlefield:[]}
        },
        turn: "A",
        log: []
      });
    }

    alert(`プレイヤー${playerId}として参加しました！`);
  };

  // ===== 描画 =====
  function render(){
    if(!playerId || !gameData) return;

    // 手札描画
    const handDiv = document.getElementById("hand");
    handDiv.innerHTML = "";
    gameData.players[playerId].hand.forEach((card,i)=>{
      const btn = document.createElement("button");
      btn.textContent = card;
      btn.onclick = ()=>playCard(i);
      btn.disabled = (gameData.turn !== playerId);
      handDiv.appendChild(btn);
    });

    // 場描画
    const bfDiv = document.getElementById("battlefield");
    bfDiv.innerHTML = "";
    Object.keys(gameData.players).forEach(pid=>{
      gameData.players[pid].battlefield.forEach(card=>{
        const c = document.createElement("div");
        c.textContent = pid + ": " + card;
        bfDiv.appendChild(c);
      });
    });

    // ゲームログ描画
    const logDiv = document.getElementById("log");
    logDiv.innerHTML = gameData.log.join("<br>");
  }

  // ===== カードをプレイ =====
  function playCard(index){
    if(!playerId || !gameData) return;
    if(gameData.turn !== playerId) return;

    gameRef.transaction(game => {
      if(!game) return game;
      const card = game.players[playerId].hand.splice(index,1)[0];
      game.players[playerId].battlefield.push(card);
      game.log.push(playerId + " が " + card + " をプレイ");
      // ターン交代
      game.turn = (playerId==="A")?"B":"A";
      return game;
    });
  }

</script>
</body>
</html>
